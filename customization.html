<!DOCTYPE html>
<html lang=" en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Furniture</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .container {
            display: flex;
            justify-content: center;
            /* Center horizontally */
            align-items: center;
            height: 100vh;
            width: 100vw;
            padding: 0;
            box-sizing: border-box;
        }

        .btn1 {
            margin: 15px;
            justify-content: space-between;
            align-items: center;
            display: flex;
            padding: 20px;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropbtn {
            background-color: #333;
            border: none;
            cursor: pointer;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 100px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #ddd;
        }

        .nav-list li a:hover,
        .dropbtn:hover {
            background-color: #575757;
        }

        li {
            position: relative;
        }

        .cart-count {
            position: absolute;
            top: -5px;
            right: -10px;
            background-color: red;
            color: white;
            padding: 4px 8px;
            border-radius: 50%;
            font-size: 10px;
        }

        .image-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .image-option {
            display: inline-block;
            cursor: pointer;
            position: relative;
        }

        .image-option input[type="radio"] {
            display: none;
        }

        .image-option label {
            display: block;
        }

        .image-option img {
            border: 2px solid transparent;
            border-radius: 8px;
            transition: border-color 0.3s ease;
            width: 100px;
            height: auto;
        }

        .image-option input[type="radio"]:checked+label img {
            border-color: #007bff;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header>
        <div class="logo">Funi Designs</div>
        <nav>
            <ul>
                <li><a href="home.html">Home</a></li>
                <li><a href="customization.html">Customize Furniture</a></li>
                <li><a href="shop.html">Shop</a></li>
                <li><a href="Aboutus.html">About Us</a></li>
                <li><a href="contactus.html">Contact Us</a></li>
                <li>
                    <a href="Cart.html">
                        <box-icon name="cart" type="solid" flip="horizontal"></box-icon>
                        <span class="cart-count" id="cart-count">3</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="dropdown">
            <button class="dropbtn"><box-icon type='solid' name='user'></box-icon></button>
            <div class="dropdown-content">
                <a href="#" id="open-profile-modal">Update Profile</a>
                <a href="orders.html">My orders</a>
                <a href="index.html">LogOut</a>
            </div>
        </div>
    </header>


    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h1>User Profile</h1>
            <form id="profile-form">
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone:</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="address">Address:</label>
                    <textarea id="address" name="address" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password">
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm Password:</label>
                    <input type="password" id="confirm-password" name="confirm-password">
                </div>
                <div class="form-buttons">
                    <button type="submit">Update Profile</button>
                    <button type="button" id="cancel-button">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Customize Furniture Section -->
    <section class="customize-furniture">
        <h1>Customize Your Furniture</h1>
        <p>Choose your product and customize it to fit your style.</p>
        <div class="container">

            <!-- Product Details Display -->
            <div id="product-details" class="customization-options">

            </div>

            <!-- Customization Form -->
            <section class="customization-form">
                <h2>Customize Your Selection</h2>
                <form id="customization-form">
                    <label for="component-image">Custom Component:</label>
                    <div id="image-options" class="image-options">
                    </div>
                    <label for="material">Select Material:</label>
                    <select id="material" name="material">
                    </select>

                    <label for="color">Select Leg Color:</label>
                    <select id="color" name="color">
                    </select>
                    <div class="btn1">
                        <button type="submit" class="cta-button">Save</button>
                        <button type="button" id="add-to-cart" class="cta-button">Add to Cart</button>
                    </div>



                </form>
            </section>

        </div>
    </section>
    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Message!</h2>
            <p id="successMessage">Your action was successful.</p>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="quick-links">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="#">Home</a></li>
                    <li><a href="#">Products</a></li>
                    <li><a href="#">Orders</a></li>
                    <li><a href="#">Contact Us</a></li>
                </ul>
            </div>
            <div class="social-icons">
                <a href="#"><img src="facebook-icon.png" alt="Facebook"></a>
                <a href="#"><img src="twitter-icon.png" alt="Twitter"></a>
                <a href="#"><img src="instagram-icon.png" alt="Instagram"></a>
            </div>
        </div>
    </footer>
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    <script src="script.js"></script>
    <script src="JS/javascript.js"></script>


    <script>
        function popUp(message) {
            const modal = document.getElementById("successModal");
            const successMessage = document.getElementById("successMessage");
            successMessage.textContent = message;
            modal.style.display = "block";

            const closeButton = document.querySelector("#successModal .close");
            closeButton.onclick = function () {
                modal.style.display = "none";
            };

            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Failed to parse JWT:', error);
                return null;
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                console.error('Product ID is missing');
                return;
            }

            fetch(`http://localhost:5000/api/products/${productId}`)
                .then(response => response.json())
                .then(product => {
                    if (product.res === 'no-results') {
                        console.error('Product not found');
                        return;
                    }

                    const productType = product.prod_type;
                    //console.log(productType);
                    return fetch(`http://localhost:5000/api/matched-items?type=${encodeURIComponent(productType)}`);
                })
                .then(response => response.json())
                .then(items => {
                    if (items.res === 'error') {
                        console.error('Error fetching matched items');
                        return;
                    }

                    const materialSelect = document.getElementById('material');
                    const colorSelect = document.getElementById('color');
                    const imageSelect = document.getElementById('image');

                    materialSelect.innerHTML = '';
                    colorSelect.innerHTML = '';

                    const uniqueMaterials = [...new Set(items.map(item => item.material))];
                    uniqueMaterials.forEach(material => {
                        const option = document.createElement('option');
                        option.value = material;
                        option.textContent = material.charAt(0).toUpperCase() + material.slice(1);
                        materialSelect.appendChild(option);
                    });

                    const uniqueColors = [...new Set(items.map(item => item.color))];
                    uniqueColors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color;
                        option.textContent = color.charAt(0).toUpperCase() + color.slice(1);
                        colorSelect.appendChild(option);
                    });

                    items.forEach((item) => {
                        const imageContainer = document.getElementById('image-options');
                        const imgOption = document.createElement('div');
                        imgOption.classList.add('image-option');

                        imgOption.innerHTML = `
                            <input type="radio" name="component-image" value="${item.image}" id="component-${item.comp_ID}">
                            <label for="component-${item.comp_ID}">
                                <img src="${item.image}" alt="${item.comp_Name}" title="${item.comp_Name}">
                            </label>
                        `;

                        imageContainer.appendChild(imgOption);
                    });
                })
                .catch(error => {
                    console.error('Error fetching product or matched items:', error);
                });
        });



        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            if (productId) {
                fetch(`http://localhost:5000/api/products/${productId}`)
                    .then(response => response.json())
                    .then(product => {
                        const productDetails = document.getElementById('product-details');

                        const productImage = document.createElement('img');
                        productImage.src = product.Image;
                        productImage.alt = product.prod_name;

                        const productName = document.createElement('h2');
                        productName.textContent = product.prod_name;

                        const productDescription = document.createElement('p');
                        productDescription.textContent = product.description;

                        const productPrice = document.createElement('p');
                        productPrice.innerHTML = `<strong>Price: R${product.prod_price}</strong>`;

                        productDetails.appendChild(productImage);
                        productDetails.appendChild(productName);
                        productDetails.appendChild(productDescription);
                        productDetails.appendChild(productPrice);
                    })
                    .catch(error => {
                        console.error('Error fetching product:', error);
                    });
            }

            document.getElementById('customization-form').addEventListener('submit', (event) => {
                event.preventDefault();

                function getCookie(name) {
                    const value = "; " + document.cookie;
                    const parts = value.split("; " + name + "=");
                    if (parts.length === 2) return parts.pop().split(";").shift();
                }

                const authToken = getCookie("sessionToken");

                if (authToken) {
                    console.log("Token retrieved:", authToken);
                } else {
                    console.log("No token found.");
                }

                const imageOptions = document.getElementsByName('component-image');
                let selectedImage = null;

                for (let option of imageOptions) {
                    if (option.checked) {
                        selectedImage = option.value;
                        console.log("Selected Image:", selectedImage);
                        break;
                    }
                }

                if (!selectedImage) {
                    console.error("No image option selected.");
                    popUp("Please select an image before submitting.");
                    return;
                }

                const material = document.getElementById('material');
                const selectedMaterial = material.value;
                const color = document.getElementById('color');
                const selectedColor = color.value;

                const productId = new URLSearchParams(window.location.search).get('id');
                const cus_Type = 'Furniture';
                const cus_Option = 'Customize';

                const components = {
                    material: selectedMaterial,
                    color: selectedColor,
                    image: selectedImage
                };

                fetch('http://localhost:5000/api/addCustomization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify({ prod_ID: productId, cus_Type, cus_Option, components })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            popUp('Error adding customization!');
                        } else {
                            popUp('Successfully added!');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            });

            function getCookie(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
            }

            const authToken = getCookie("sessionToken");

            if (authToken) {
                console.log("Token retrieved:", authToken);
            } else {
                console.log("No token found.");
            }

            document.getElementById('add-to-cart').addEventListener('click', () => {
                const productId = new URLSearchParams(window.location.search).get('id');
                console.log("Product ID:", productId);
                const quantity = 1;

                const priceElement = document.querySelector('#product-details p strong');
                const price = priceElement ? priceElement.textContent.replace('Price: $', '') : null;

                if (!productId || !quantity || !price) {
                    popUp('Product ID, quantity, and price are required');
                    return;
                }

                const decodedToken = parseJwt(authToken);
                const user_ID = decodedToken ? decodedToken.user_ID : null;
                const prod_id = productId ? parseInt(productId) : null;

                if (!prod_id) {
                    popUp('Product ID is missing or invalid');
                    return;
                }

                if (!user_ID) {
                    console.error('Failed to extract user_ID from the token');
                    return;
                }

                const imageOptions = document.getElementsByName('component-image');
                let selectedImage = null;

                for (let option of imageOptions) {
                    if (option.checked) {
                        selectedImage = option.value;
                        console.log("Selected Image:", selectedImage);
                        break;
                    }
                }

                if (!selectedImage) {
                    console.error("No image option selected.");
                    popUp("Please select an image before submitting.");
                    return;
                }

                const material = document.getElementById('material');
                const selectedMaterial = material.value;
                const color = document.getElementById('color');
                const selectedColor = color.value;

                console.log("Selected Color:", selectedColor);
                console.log("Selected Material:", selectedMaterial);
                console.log("Components:", { material: selectedMaterial, color: selectedColor, image: selectedImage });

                const component = {
                    material: selectedMaterial,
                    color: selectedColor,
                    image: selectedImage
                };

                const data = {
                    user_ID: user_ID,
                    prod_id: prod_id,
                    quantity: quantity,
                    price: price,
                    components: component
                };
                console.log(component);

                fetch('http://localhost:5000/api/AddTocart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authToken
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error adding to cart:', data.error);
                            popUp('Error adding item to cart.');
                        } else {
                            popUp('Item added to cart successfully!');
                            setTimeout(() => {
                                window.location.href = 'Cart.html';
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        popUp('An error occurred while adding the item to the cart.');
                    });
            });


        });

    </script>
</body>

</html>